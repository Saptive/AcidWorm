# AcidWorm

**AcidWorm** is a NetWorm malware inspired by the 2004 **Sasser** worm. It is the second member of the Acid malware family, second to **AcidRain**.
This project was developed purely for fun, aiming to improve my reverse engineering and exploit development skills along with my understanding of windows internals.

## Description
AcidWorm’s infection process is based on the MS04‑011 `DsRolerUpgradeDownlevelServer` vulnerability in `lsasrv.dll`, which allows remote execution with **SYSTEM** privileges.  
The propagation flow proceeds as follows:

- The LSASS RPC buffer overflow is triggered, overwriting the return address and redirecting execution into shellcode placed within the incoming packet.
- The injected shellcode launches a bindshell on TCP port **2421**, running with full `SYSTEM` privileges.
- The worm then connects back to this remote shell and uploads a small `.ftp` script to the victim machine.
- This script is written to disk and executed, initiating retrieval of the main executable payload via a minimal FTP-like data transfer mechanism.
- After download is complete, the retrieved executable is launched through the same remote shell, allowing the worm to repeat the process on additional hosts.

### Network
This diagram represents the typical client–server packet exchange in the exploitation stage:

![network traffic](https://github.com/user-attachments/assets/01ddbac9-bef3-41d7-b7b0-320f1617b485)

The `DsRoleUpgradeDownlevelServer` request never receives a response, because the overflow diverts execution before the handler completes.  
Everything that follows is generated by the injected payload, including the FTP‑style authentication and file transfer commands.

### FTP server implementation
AcidWorm includes a lightweight FTP‑like server that runs independently in a separate thread.  
It supports the following commands:

- `USER`
- `PASS`
- `BIN`
- `PORT`
- `RETR`
- `QUIT`

The purpose of this server is to provide an automated mechanism for delivering the worm’s executable payload to the newly compromised system.

![ftp traffic](https://github.com/user-attachments/assets/57d31d3c-9c68-4cac-851a-a9088eb05846)

## The Vulnerability
AcidWorm targets a vulnerability within `lsasrv.dll`, in a function responsible for writing to the `DCPROMO.LOG` file under `C:\WINDOWS\Debug`.

This function is called by multiple RPC‑exposed routines, but `DsRolerUpgradeDownlevelServer` is the only one lacking proper security checks, making it exploitable for remote attacks. This function was originally intended to be **only locally accessible**, which explains the lack of security checks in the RPC handler. With minor adjustments to `netapi.dll`, it can be invoked remotely, and a valid request packet can then be replayed for exploitation.

![RPC interface functions](https://github.com/user-attachments/assets/57f1dbc0-8393-4186-836b-cceb05e5719e)

The issue stems from the use of `vsprintf()` without bounds validation on the destination buffer:

![vsprintf](https://github.com/user-attachments/assets/3514258e-3ba6-485d-a1cc-2f7597f1fad9)

A buffer of roughly **3320 bytes** can be overflowed, allowing the stored return address to be overwritten and execution to be redirected into attacker‑supplied data.

An important detail is that on this buffer is converted to a **wide‑character** string before processing. This would normally corrupt the return address, since each byte becomes part of a two‑byte sequence. However, due to the absence of ASLR at the time, it is possible to locate a usable `CALL ESP` instruction whose address still aligns after Unicode expansion.

![multi-byte to whcar](https://github.com/user-attachments/assets/591b5dec-5440-409f-9db3-59494aacdde4)

![call esp address](https://github.com/user-attachments/assets/429fb9e1-e774-4931-9f38-92433e1854cf)


## The shellcode and payload
AcidWorm uses a bindshell payload to communicate with the attacking system.  
The overwritten return address redirects execution to a `CALL ESP`, which points back into the overflowed buffer:

![jmp to decryptor](https://github.com/user-attachments/assets/96de8c53-6d01-40e0-9c9c-eb4548f5a441)

This code jumps to code snippet that decrypts the payload itself, as it is XOR encrypted. After it's done, it jumps to the beginning of the decrypted shellcode block.

![payload decrypt and payload](https://github.com/user-attachments/assets/d4ea8c86-d71b-4640-989b-5919241b7d85)

This payload then launches the bindshell and sets the stage for remote propagation and payload delivery.



## Showcase video


https://github.com/user-attachments/assets/27754144-6872-4be1-82d8-4e5b5cab1460



https://github.com/user-attachments/assets/fec05f4e-d4ef-405b-ac50-b206ee48b2ba


## Legal Disclaimer

This project is intended solely for educational and research purposes. Do not use it to attack or compromise systems without explicit authorization.  

The author is not responsible for any misuse, damage, or legal consequences arising from this code. Use only in safe, isolated, and authorized environments.  

By using this project, you accept responsibility for complying with all applicable laws and ethical standards.


